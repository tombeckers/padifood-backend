# Forward https://api.padi.hammer-intel.tools to padifood-backend (uvicorn on 8001).
#
# 1) Get SSL cert (if not already):
#    sudo certbot certonly --webroot -w /var/www/html -d api.padi.hammer-intel.tools
#
# 2) Append the blocks below into /etc/nginx/nginx.conf inside the http { } block
#    (after the api.hammer-intel.tools 443 server block, before the final "}").
#
# 3) Test and reload:
#    sudo nginx -t && sudo systemctl reload nginx

    # HTTP redirect for api.padi.hammer-intel.tools
    server {
        listen 80;
        server_name api.padi.hammer-intel.tools;

        location /.well-known/acme-challenge/ {
            root /var/www/html;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # Padifood API: api.padi.hammer-intel.tools -> uvicorn on 8001
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name api.padi.hammer-intel.tools;

        ssl_certificate /etc/letsencrypt/live/api.padi.hammer-intel.tools/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/api.padi.hammer-intel.tools/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

        include /etc/nginx/snippets/504-timeouts.conf;

        location / {
            proxy_pass http://127.0.0.1:8001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
    }
